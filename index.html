<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criador Universal de Formul√°rios (v3.3 - Fixes/Feedback)</title> 
    
    <script src="https://unpkg.com/vanilla-masker@1.1.1/build/vanilla-masker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        /* ======================================================= */
        /* CSS CORE - Estrutura e Cores (Mantido) */
        /* ======================================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input/Form Styles */
        textarea {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            margin-top: 20px;
        }

        .form-group {
             margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #343a40;
        }
        
        body.dark-mode .form-group label {
            color: #e9ecef;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: #1a1a2e;
            border-color: #343a40;
            color: #e9ecef;
        }


        /* Card and Feature Highlighting */
        .variable-card, .group-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        body.dark-mode .variable-card, body.dark-mode .group-card {
            background: #16213e;
            border-color: #0f3460;
        }
        
        /* Estilos para L√≥gica Condicional e C√°lculo */
        .conditional-field-config {
            border-left: 4px solid #ffc107; /* Amarelo */
            padding-left: 15px;
            margin-left: 5px;
            background: #fffbe6;
            padding-top: 10px;
            margin-bottom: 15px;
        }
        
        .calculation-field-config {
            border-left: 4px solid #28a745; /* Verde */
            padding-left: 15px;
            margin-left: 5px;
            background: #f0fff4;
            padding-top: 10px;
            margin-bottom: 15px;
        }
        
        body.dark-mode .conditional-field-config { background: #383015; }
        body.dark-mode .calculation-field-config { background: #193819; }

        .variable-card.conditional {
            border: 2px solid #ffc107;
        }

        .variable-card.calculation {
            border: 2px solid #28a745;
        }
        
        /* Drag & Drop Styles */
        .upload-area {
            text-align: center;
            padding: 35px; 
            border: 3px dashed #667eea; 
            border-radius: 15px;
            cursor: pointer;
            background: #f0f4ff; 
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #e3e9ff;
        }

        body.dark-mode .upload-area {
            background: #1a1a2e;
            color: #e9ecef;
        }
        
        /* Bot√µes */
        .btn-primary, .btn-secondary, .btn-delete, .btn-use, .btn-delete-small {
             display: inline-flex;
             align-items: center;
             gap: 10px;
             padding: 15px 30px;
             border-radius: 10px;
             cursor: pointer;
             font-size: 16px;
             font-weight: 600;
             border: none;
             transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn-use {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
        }
        
        .btn-delete-small {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
        }
        
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            animation: fadeInModal 0.3s;
        }

        .modal.active {
            display: block; 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 30px;
            border-radius: 15px;
            width: 90%; 
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        
        /* Estilos para o Modal de Ajuda */
        .help-modal-content ul {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
        }
        
        .help-modal-content li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .help-modal-content li:before {
            content: '‚Ä¢';
            color: #764ba2;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        
        .help-modal-content pre {
            background: #eee;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.9em;
            overflow-x: auto;
            margin-top: 5px;
        }
        
        body.dark-mode .help-modal-content pre {
            background: #343a40;
            color: #e9ecef;
        }


        /* Dark Mode Styles */
        #darkModeToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        /* NOVO ESTILO PARA O BOT√ÉO DO USU√ÅRIO */
        #userToggle {
            position: fixed;
            top: 70px; /* Abaixo do DarkModeToggle (20px + 40px + 10px de margem) */
            right: 20px; 
            z-index: 1001;
            background: #007bff; /* Azul para usu√°rio */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        #userToggle:hover {
            background: #0056b3;
        }
        
        body.dark-mode #userToggle {
            background: #17a2b8;
        }
        
        /* AJUSTE PARA O BOT√ÉO DE AJUDA - POSICIONADO ABAIXO DO USER TOGGLE */
        #helpToggle {
            position: fixed;
            top: 120px; /* Abaixo do UserToggle (70px + 40px + 10px de margem) */
            right: 20px; /* Alinhado √† direita com o darkModeToggle */
            z-index: 1001;
            background: #20c997; /* Verde/Ciano para destaque */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        #helpToggle:hover {
            background: #17a2b8;
        }
        
        /* Dark Mode adjustment for Help Toggle */
        body.dark-mode #helpToggle {
            background: #17a2b8;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e9ecef;
        }

        body.dark-mode .container {
            background: #0f3460;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }
        
        body.dark-mode .modal-content {
            background-color: #0f3460;
            color: #e9ecef;
        }

        /* Novas Classes para Preview */
        .preview-area {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            border: 1px solid #ddd;
            min-height: 200px;
            color: #333;
        }
        
        body.dark-mode .preview-area {
            background: #1a1a2e;
            border-color: #343a40;
            color: #e9ecef;
        }

        .preview-area .highlight {
            font-weight: bold;
            color: #764ba2;
            background: #e6e6fa; 
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        body.dark-mode .preview-area .highlight {
            color: #fff;
            background: #764ba2;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-direction: column; 
            text-align: left;
        }
        
        .alert-error div {
            width: 100%;
        }

        /* Classes para a aba Predefined Templates */
        .predefined-template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .template-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        body.dark-mode .template-card {
            background: #16213e;
            border-color: #0f3460;
        }

        .template-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 20px;
            width: 0%;
            background-color: #28a745;
            transition: width 0.4s ease-in-out;
            text-align: center;
            color: white;
            line-height: 20px;
            font-weight: bold;
        }

        /* NOVO: Estilos para Notifica√ß√µes (Pode durar 5 segundos) */
        #notificationContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000; /* Acima de tudo, exceto talvez o modal */
        }

        .notification {
            background-color: #343a40;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(20px);
            max-width: 300px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Dark Mode for Notification */
        body.dark-mode .notification {
            background-color: #1a1a2e;
            border: 1px solid #0f3460;
        }


        /* Responsive Fixes */
        @media (max-width: 768px) {
            .upload-area {
                padding: 25px 15px; 
            }
            
            .header {
                 padding: 20px 20px 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab {
                padding: 15px 10px;
                font-size: 14px;
            }
            
            .btn-primary, .btn-secondary {
                padding: 12px 20px;
                font-size: 14px;
            }

            .tab-content {
                padding: 20px;
            }
            
            .container {
                margin: 0 5px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <button id="darkModeToggle" onclick="toggleDarkMode()">‚òÄÔ∏è</button>
    <button id="userToggle" onclick="openNameModal()" title="Gerenciar Usu√°rio e Sauda√ß√µes">üë§</button> 
    <button id="helpToggle" onclick="openModal('helpModal')" title="Ajuda (Guia Passo a Passo)">‚ùì</button> 
    
    <div id="notificationContainer"></div> 
    
    <div class="container">
        <div class="header">
            <h1>üöÄ Criador Universal de Formul√°rios</h1>
            <p>Transforme qualquer documento em um formul√°rio inteligente (v3.3 - Fixes/Feedback)</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">
                <span>üì§</span> Upload Template
            </button>
            <button class="tab" onclick="switchTab('predefined')">
                <span>üìã</span> Templates Prontos
            </button>
            <button class="tab" onclick="switchTab('config')">
                <span>‚öôÔ∏è</span> Configurar Vari√°veis
            </button>
            <button class="tab" onclick="switchTab('fill')">
                <span>‚úçÔ∏è</span> Preencher Formul√°rio
            </button>
            <button class="tab" onclick="switchTab('preview')">
                <span>üëÅÔ∏è</span> Preview & Download
            </button>
        </div>

        <div id="tab-upload" class="tab-content active">
            <div class="alert alert-info">
                <span>‚ÑπÔ∏è</span>
                <span>Fa√ßa upload de um documento ou cole o texto. Use <strong>{variavel}</strong> para definir campos no seu template.</span>
            </div>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÑ</div>
                <h3>Arraste um arquivo aqui ou clique para selecionar</h3>
                <p style="margin-top: 10px; color: #6c757d;">Suporta: .txt, .pdf</p>
                <input type="file" id="fileInput" accept=".txt,.pdf" onchange="handleFile(event)" style="display: none;">
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 10px;">Ou cole seu template aqui:</h3>
            <textarea id="templateText" placeholder="Exemplo:&#10;&#10;CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS&#10;&#10;Contratante: {nome_contratante}&#10;CPF: {cpf_contratante}&#10;Valor do Servi√ßo: R$ {valor_base_multa}"></textarea>

            <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                <button class="btn-primary" onclick="processTemplate()">
                    <span>üîç</span> Detectar Vari√°veis
                </button>
                
                <div style="display: flex; align-items: center; margin-left: 10px;">
                    <input type="checkbox" id="removeEmojisFlag" style="margin-right: 5px;">
                    <label for="removeEmojisFlag" style="font-weight: 400; font-size: 14px; color: #6c757d;">Remover emojis/caracteres especiais?</label>
                </div>
                
                <button class="btn-secondary" onclick="saveTemplateModal()">
                    <span>üíæ</span> Salvar como Modelo
                </button>
                <button class="btn-secondary" onclick="openLoadTemplateModal()">
                    <span>üìö</span> Gerenciar/Usar Modelos
                </button>
            </div>
        </div>
        
        <div id="tab-predefined" class="tab-content">
             <div class="alert alert-info">
                <span>üí°</span>
                <span>Selecione um dos nossos templates profissionais prontos para usar.</span>
            </div>
            <div id="predefinedTemplateGrid" class="predefined-template-grid">
                </div>
        </div>

        <div id="tab-config" class="tab-content">
            <h2 style="margin-bottom: 20px;">Configurar Vari√°veis Normais</h2>
            <div id="variablesConfig"></div>
        </div>

        <div id="tab-fill" class="tab-content">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            <p style="text-align: center; margin-bottom: 20px; color: #6c757d;" id="progressText">0 de 0 campos preenchidos</p>

            <div id="validationErrors" style="display: none; margin-bottom: 20px;"></div>

            <div id="formFields"></div>

            <div style="margin-top: 30px;">
                <button class="btn-primary" onclick="generatePreview()">
                    <span>üëÅÔ∏è</span> Gerar Preview
                </button>
                <button class="btn-secondary" onclick="clearForm()">
                    <span>üóëÔ∏è</span> Limpar Formul√°rio
                </button>
            </div>
        </div>

        <div id="tab-preview" class="tab-content">
            <div class="alert alert-success">
                <span>‚úÖ</span>
                <span>Documento gerado com sucesso! Revise antes de fazer o download.</span>
            </div>
            
            <div class="preview-area" id="previewArea">
                <em style="color: #6c757d;">O preview do documento aparecer√° aqui ap√≥s preencher o formul√°rio...</em>
            </div>

            <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                <button class="btn-primary" onclick="downloadDocument()">
                    <span>üíæ</span> Download .TXT
                </button>
                <button class="btn-secondary" onclick="downloadDocumentPDF()">
                    <span>üìÑ</span> Exportar .PDF
                </button>
                <button class="btn-secondary" onclick="copyToClipboard()">
                    <span>üìã</span> Copiar Texto
                </button>
            </div>
        </div>

        <div id="saveTemplateModal" class="modal" onclick="if(event.target.id === 'saveTemplateModal') closeModal('saveTemplateModal')">
            <div class="modal-content">
                <h2>üíæ Salvar Template</h2>
                <div class="form-group">
                    <label>Nome do Template:</label>
                    <input type="text" id="templateName" placeholder="Contrato de Presta√ß√£o de Servi√ßos">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o:</label>
                    <textarea id="templateDescription" placeholder="Breve descri√ß√£o do uso do template..." style="min-height: 80px;"></textarea>
                </div>
                <button class="btn-primary" onclick="confirmSaveTemplate()">Salvar</button>
            </div>
        </div>
        
        <div id="loadTemplateModal" class="modal" onclick="if(event.target.id === 'loadTemplateModal') closeModal('loadTemplateModal')">
            <div class="modal-content">
                <h2>üìö Gerenciar Modelos Salvos</h2>
                <div id="savedTemplatesList">
                    <p style="text-align: center; color: #6c757d;">Carregando modelos...</p>
                </div>
                <button class="btn-secondary" style="margin-top: 20px;" onclick="closeModal('loadTemplateModal')">Fechar</button>
            </div>
        </div>

        <div id="helpModal" class="modal" onclick="if(event.target.id === 'helpModal') closeModal('helpModal')">
            <div class="modal-content help-modal-content">
                <h2>üìö Guia R√°pido de Uso</h2>
                <p>Este guia explica as funcionalidades principais para criar e preencher seu documento inteligente.</p>
                
                <hr style="margin: 15px 0;">

                <h3>1. üì§ Upload Template</h3>
                <p style="font-weight: 600;">Definindo Vari√°veis:</p>
                <ul>
                    <li>Use o formato **<code>{nome_variavel}</code>** no seu texto (template) para marcar os campos que ser√£o preenchidos.</li>
                    <li>Clique em **üîç Detectar Vari√°veis** para a ferramenta identific√°-las.</li>
                </ul>
                
                <hr style="margin: 15px 0;">

                <h3>2. ‚öôÔ∏è Configurar Vari√°veis</h3>
                <p style="font-weight: 600;">Prop√≥sitos Especiais (Clareza no C√°lculo):</p>
                <ul>
                    <li>‚úÖ **C√°lculo Autom√°tico (Verde):** Usado para vari√°veis que ter√£o seu valor calculado.
                        <p style="margin: 5px 0 0; font-style: italic;">Exemplo: <code>{valor_total} = {valor_base} * (1 + {agravamento})</code>.</p>
                        <p style="margin: 5px 0 0; font-style: italic; color: #764ba2;"><strong>Dica de C√°lculo:</strong> Se um campo normal for marcado como **percentual**, a ferramenta o divide automaticamente por 100 no c√°lculo, permitindo que voc√™ digite <code>10</code> para 10%.</p>
                    </li>
                    <li>‚úÖ **Campo Condicional (Amarelo):** Usado para vari√°veis que exibem um **bloco inteiro de texto** se uma condi√ß√£o for verdadeira.
                        <p style="margin: 5px 0 0;">As tags no template devem ser:</p>
                        <pre>{START_COND:variavel_condicional}
    Bloco de Texto a Ser Exibido
{END_COND:variavel_condicional}</pre>
                    </li>
                </ul>

                <hr style="margin: 15px 0;">

                <h3>3. ‚úçÔ∏è Preencher Formul√°rio</h3>
                <p style="font-weight: 600;">Valida√ß√£o e Automa√ß√£o:</p>
                <ul>
                    <li>A barra de progresso acompanha os campos obrigat√≥rios.</li>
                    <li>A ferramenta faz valida√ß√£o de **CPF** e **CNPJ** (se o nome da vari√°vel contiver "cpf" ou "cnpj").</li>
                    <li>**Autocompletar CEP:** Se o nome da vari√°vel contiver "cep", o endere√ßo completo ser√° buscado e preenchido automaticamente (se a vari√°vel <code>{endereco_completo}</code> existir).</li>
                </ul>
                
                <hr style="margin: 15px 0;">
                
                <h3>4. üëÅÔ∏è Preview & Download</h3>
                <p>Gere o Preview para revisar o documento final. Campos preenchidos e vazios s√£o destacados. Voc√™ pode baixar em **.TXT** ou **.PDF**.</p>
                
                <button class="btn-primary" style="margin-top: 20px;" onclick="closeModal('helpModal')">Entendido! Fechar Guia</button>
            </div>
        </div>

        <div id="welcomeModal" class="modal" onclick="if(event.target.id === 'welcomeModal') closeModal('welcomeModal')">
            <div class="modal-content">
                <h2>üëã Boas-Vindas!</h2>
                <p>Parece que √© sua primeira vez ou voc√™ limpou o cache. Gostaria de configurar seu nome para receber sauda√ß√µes e dicas personalizadas?</p>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>Seu Nome (Opcional):</label>
                    <input type="text" id="initialUserName" placeholder="Digite seu nome">
                </div>
                
                <div class="form-group">
                    <input type="checkbox" id="receiveGreetings" checked style="margin-right: 5px;">
                    <label for="receiveGreetings" style="display: inline; font-weight: normal;">Receber sauda√ß√µes e dicas na inicializa√ß√£o.</label>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn-secondary" onclick="handleWelcome(false)">N√£o, Obrigado</button>
                    <button class="btn-primary" onclick="handleWelcome(true)">Confirmar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ====================================================================
        // GEST√ÉO DO INDEXEDDB (Modelos)
        // ====================================================================
        const DB_NAME = 'FormProDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'templates';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => { db = event.target.result; resolve(db); };
                request.onerror = (event) => { console.error('IndexedDB error:', event.target.errorCode); reject(event.target.errorCode); };
            });
        }

        function getStore(mode) {
            const transaction = db.transaction([STORE_NAME], mode);
            return transaction.objectStore(STORE_NAME);
        }

        async function saveTemplateToDB(template) {
            await openDB();
            return new Promise((resolve, reject) => {
                const request = getStore('readwrite').put(template);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        }

        async function loadAllTemplatesFromDB() {
            await openDB();
            return new Promise((resolve, reject) => {
                const request = getStore('readonly').getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (e) => reject(e);
            });
        }
        
        async function deleteTemplateFromDB(id) {
            await openDB();
            return new Promise((resolve, reject) => {
                const numericId = parseInt(id, 10);
                const request = getStore('readwrite').delete(numericId);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        }

        // ====================================================================
        // VARI√ÅVEIS E INICIALIZA√á√ÉO
        // ====================================================================
        let templateContent = '';
        let variables = []; 
        let formData = {}; 
        let savedTemplates = []; 
        let isDarkMode = false;
        let userName = ''; // Armazena o nome do usu√°rio (NOVO)
        let receiveGreetings = true; // Flag para sauda√ß√µes e dicas (NOVO)
        
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
        }

        // ====================================================================
        // FUN√á√ïES GERAIS DE UI
        // Estas fun√ß√µes n√£o estavam definidas, mas s√£o necess√°rias para os Modais
        // ====================================================================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('darkModeToggle').textContent = isDarkMode ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('darkMode', isDarkMode);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');

            if (tabName === 'config') {
                renderConfigTab();
            } else if (tabName === 'fill') {
                renderFormTab();
            } else if (tabName === 'preview') {
                // Chamada de valida√ß√£o e preview √© feita no bot√£o da aba 'Preencher Formul√°rio'
            } else if (tabName === 'predefined') {
                renderPredefinedTemplates();
            }
        }
        
        // ====================================================================
        // GEST√ÉO DE USU√ÅRIO, SAUDA√á√ïES E NOTIFICA√á√ïES (NOVOS REQUISITOS)
        // ====================================================================
        function getUserConfig() {
            userName = localStorage.getItem('userName') || '';
            const greetings = localStorage.getItem('receiveGreetings');
            receiveGreetings = greetings !== null ? (greetings === 'true') : true;
        }
        
        function saveUserConfig() {
            localStorage.setItem('userName', userName);
            localStorage.setItem('receiveGreetings', receiveGreetings);
            renderUserButton();
        }

        /**
         * Exibe uma notifica√ß√£o tempor√°ria no canto inferior direito.
         * @param {string} message - A mensagem a ser exibida.
         * @param {number} duration - Dura√ß√£o em milissegundos (padr√£o 5000ms = 5s).
         */
        function showNotification(message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `<span>üí¨</span> ${message}`;
            container.appendChild(notification);

            // For√ßar reflow para a anima√ß√£o
            void notification.offsetWidth; 
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove());
            }, duration);
        }
        
        function renderUserButton() {
            const button = document.getElementById('userToggle');
            const emoji = userName ? 'üòä' : 'üë§';
            button.innerHTML = emoji;
            button.title = userName ? `Ol√°, ${userName}! (Configura√ß√µes)` : 'Gerenciar Usu√°rio e Sauda√ß√µes';
        }
        
        function openNameModal() {
            // Reutiliza o welcomeModal para mudar o nome
            document.getElementById('initialUserName').value = userName;
            document.getElementById('receiveGreetings').checked = receiveGreetings;
            document.querySelector('#welcomeModal h2').textContent = 'Configura√ß√µes do Usu√°rio';
            document.querySelector('#welcomeModal p').textContent = 'Altere seu nome e prefer√™ncias de sauda√ß√µes.';
            openModal('welcomeModal');
        }

        function handleWelcome(confirm) {
            const inputName = document.getElementById('initialUserName').value.trim();
            const shouldGreet = document.getElementById('receiveGreetings').checked;
            
            closeModal('welcomeModal');
            
            // 1. Atualizar e salvar config
            userName = confirm && inputName ? inputName : '';
            receiveGreetings = confirm ? shouldGreet : false;
            saveUserConfig();

            // 2. Notifica√ß√£o e Dicas
            if (receiveGreetings) {
                const greeting = userName ? `Ol√°, ${userName}! ` : 'Ol√°! ';
                showNotification(greeting + 'Boas-vindas ao Criador de Formul√°rios!', 5000);
                
                // Dica 500ms depois
                setTimeout(() => {
                     showNotification('Dica: Use **{variavel}** no texto e clique em **üîç Detectar Vari√°veis** na aba Upload!', 6000);
                }, 500);
            } else {
                 if (userName) {
                    showNotification(`Nome '${userName}' salvo, mas sauda√ß√µes desativadas.`, 5000);
                 } else {
                     showNotification('Sauda√ß√µes desativadas.', 5000);
                 }
            }
        }
        
        
        // Configura√ß√£o de Templates Prontos
        const predefinedTemplates = [
            { id: 101, name: "Contrato de Trabalho CLT", description: "Contrato padr√£o para regime CLT com campo condicional (vale-transporte).", 
              content: `
CONTRATO INDIVIDUAL DE TRABALHO POR PRAZO INDETERMINADO
Empregado: {nome_empregado} | CPF: {cpf_empregado}
Cargo: {cargo} | Sal√°rio: R$ {salario}
Data de Admiss√£o: {data_admissao}

Cl√°usula de Vale-Transporte:
{START_COND:vale_transporte_sim}
  O empregado DECLARA que necessita do vale-transporte para o deslocamento resid√™ncia-trabalho e vice-versa.
{END_COND:vale_transporte_sim}
{START_COND:vale_transporte_nao}
  O empregado DECLARA que N√ÉO necessita do vale-transporte.
{END_COND:vale_transporte_nao}
`, 
              variables: [
                { name: 'nome_empregado', label: 'Nome do Empregado', type: 'text', placeholder: 'Jo√£o da Silva', required: true, purpose: 'form' },
                { name: 'cpf_empregado', label: 'CPF do Empregado', type: 'text', placeholder: '000.000.000-00', required: true, purpose: 'form' },
                { name: 'cargo', label: 'Cargo', type: 'text', placeholder: 'Analista de Sistemas', required: true, purpose: 'form' },
                { name: 'salario', label: 'Sal√°rio (R$)', type: 'number', placeholder: '3000.00', required: true, purpose: 'form' },
                { name: 'data_admissao', label: 'Data de Admiss√£o', type: 'date', required: true, purpose: 'form' },
                { name: 'vale_transporte', label: 'O Empregado precisa de Vale-Transporte?', type: 'select', options: 'Sim,N√£o', placeholder: 'Selecione', required: true, purpose: 'form' },
                // Vari√°veis Condicionais
                { name: 'vale_transporte_sim', label: 'Bloco Vale-Transporte (Sim)', type: 'text', required: false, purpose: 'conditional', condition: "{vale_transporte} == 'Sim'" },
                { name: 'vale_transporte_nao', label: 'Bloco Vale-Transporte (N√£o)', type: 'text', required: false, purpose: 'conditional', condition: "{vale_transporte} == 'N√£o'" }
            ]
            },
            
            { id: 102, name: "Termo de Confidencialidade (NDA)", description: "Acordo padr√£o para prote√ß√£o de informa√ß√µes, com c√°lculo autom√°tico de multa.", 
              content: `
TERMO DE CONFIDENCIALIDADE E N√ÉO DIVULGA√á√ÉO (NDA)
Entre a Empresa {nome_empresa} (CNPJ: {cnpj_empresa}) e o Colaborador {nome_colaborador} (CPF: {cpf_colaborador}).

Vig√™ncia do Acordo: {data_inicio} a {data_fim}.

Multa por Quebra de Sigilo: 
Valor Base (R$): {valor_base_multa}
Percentual de Agravamento: {agravamento_percentual}%
Valor Final da Multa: R$ {multa_final}
`, 
              variables: [
                { name: 'nome_empresa', label: 'Nome da Empresa', type: 'text', placeholder: 'ACME Corp.', required: true, purpose: 'form' },
                { name: 'cnpj_empresa', label: 'CNPJ da Empresa', type: 'text', placeholder: '00.000.000/0000-00', required: true, purpose: 'form' },
                { name: 'nome_colaborador', label: 'Nome do Colaborador', type: 'text', placeholder: 'Ana Souza', required: true, purpose: 'form' },
                { name: 'cpf_colaborador', label: 'CPF do Colaborador', type: 'text', placeholder: '000.000.000-00', required: true, purpose: 'form' },
                { name: 'data_inicio', label: 'Data de In√≠cio da Vig√™ncia', type: 'date', required: true, purpose: 'form' },
                { name: 'data_fim', label: 'Data de Fim da Vig√™ncia', type: 'date', required: true, purpose: 'form' },
                
                // Vari√°veis de C√°lculo
                { name: 'valor_base_multa', label: 'Valor Base da Multa (R$)', type: 'number', placeholder: '10000.00', required: true, purpose: 'form' },
                { name: 'agravamento_percentual', label: 'Percentual de Agravamento (0-100)', type: 'number', placeholder: '10', required: true, purpose: 'form', isPercentage: true }, 
                { name: 'multa_final', label: 'Valor Final da Multa', type: 'number', required: false, purpose: 'calculation', description: 'Calculado automaticamente: Valor Base * (1 + Percentual).', calculationFormula: '{valor_base_multa} * (1 + {agravamento_percentual})' } 
            ]
            },
            
            { id: 103, name: "Declara√ß√£o de Resid√™ncia", description: "Documento simples para comprova√ß√£o de endere√ßo com autocompletar via CEP.", 
              content: `
DECLARA√á√ÉO DE RESID√äNCIA
Eu, {nome_declarante}, portador do CPF {cpf_declarante}, declaro que {nome_residente} reside no endere√ßo: {endereco_completo}, CEP {cep}. Situa√ß√£o da resid√™ncia: {proprietario}. Finalidade da declara√ß√£o: {finalidade}. 
`, 
              variables: [
                { name: 'nome_declarante', label: 'Nome do Declarante', type: 'text', placeholder: 'Seu Nome Completo', required: true, description: '', purpose: 'form' },
                { name: 'cpf_declarante', label: 'CPF do Declarante', type: 'text', placeholder: '000.000.000-00', required: true, description: 'Necess√°rio para valida√ß√£o de CPF', purpose: 'form' },
                { name: 'nome_residente', label: 'Nome do Residente', type: 'text', placeholder: 'Nome de quem reside', required: true, description: '', purpose: 'form' },
                { name: 'cep', label: 'CEP', type: 'text', placeholder: '99999-999', required: true, description: 'Usado para autocompletar o endere√ßo.', purpose: 'form' },
                { name: 'endereco_completo', label: 'Endere√ßo Completo', type: 'textarea', placeholder: 'Rua, N√∫mero, Bairro, Cidade, Estado', required: true, description: 'Preenchido automaticamente pelo CEP.', purpose: 'form' },
                { name: 'finalidade', label: 'Finalidade da Declara√ß√£o', type: 'text', placeholder: 'Abertura de conta banc√°ria, Matr√≠cula escolar, etc.', required: true, purpose: 'form' },
                { name: 'proprietario', label: 'Situa√ß√£o da Resid√™ncia', type: 'select', options: 'Propriet√°rio, Inquilino, Residente com Parentes', placeholder: 'Selecione a situa√ß√£o', required: true, description: 'Tipo de rela√ß√£o com o im√≥vel.', purpose: 'form' }
            ]
        } ];

        window.onload = async () => {
            // NOVO: Carregar configura√ß√µes do usu√°rio
            getUserConfig(); 
            
            const savedMode = localStorage.getItem('darkMode');
            if (savedMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = 'üåô';
            }
            
            // NOVO: Renderizar o bot√£o do usu√°rio
            renderUserButton(); 
            
            // NOVO: Checagem inicial para abrir modal
            if (!userName) {
                // Abre o modal de boas-vindas na inicializa√ß√£o se n√£o houver nome
                openModal('welcomeModal');
            } else if (receiveGreetings) {
                // Sauda√ß√£o se j√° tem nome e aceitou
                const greeting = userName ? `Ol√° de novo, ${userName}!` : 'Bem-vindo de volta!';
                showNotification(greeting, 5000);
            }

            try {
                await openDB();
                savedTemplates = await loadAllTemplatesFromDB();
            } catch (error) {
                console.error('Erro ao inicializar o banco de dados. Modelos podem n√£o estar dispon√≠veis.', error);
            }
            renderPredefinedTemplates();

            // Adiciona listeners para Drag and Drop
            const uploadArea = document.getElementById('uploadArea');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                // Simula o evento de mudan√ßa de arquivo no input original
                document.getElementById('fileInput').files = files;
                handleFile({ target: document.getElementById('fileInput') });
            }
        };


        function renderPredefinedTemplates() {
            const grid = document.getElementById('predefinedTemplateGrid');
            if (!grid) return; // Checagem de seguran√ßa
            
            grid.innerHTML = predefinedTemplates.map(template => `
                <div class="template-card">
                    <h4>${template.name}</h4>
                    <p>${template.description}</p>
                    <button class="btn-use" style="margin-top: 15px;" onclick="loadPredefinedTemplate(${template.id})">
                        <span>üöÄ</span> Usar Template
                    </button>
                </div>
            `).join('');
        }

        /**
         * FUN√á√ÉO PARA REMOVER CARACTERES QUEBRADOS E EMOJIS
         * Garante que o texto est√° limpo para PDF e processamento de vari√°veis.
         */
        function sanitizeText(text, removeEmojis = false) {
            if (!text) return ''; 

            // 1. Normaliza o texto e remove o caractere de substitui√ß√£o (frequentemente ligado a caracteres quebrados)
            text = text.normalize("NFD").replace(/\uFFFD/g, ''); 
            
            // 2. Remove caracteres invis√≠veis (zero-width spaces, soft hyphens) e non-breaking spaces
            text = text.replace(/[\u00AD\u200B\u200C\u200D\u2060\uFEFF\xA0]/g, ' '); 
            
            // 3. Remove os caracteres que frequentemente v√™m de PDFs ou c√≥pias (como o problema reportado)
            text = text.replace(/[^\x00-\x7F\xC0-\xFF\s\n]/g, ''); // Remove todos que n√£o s√£o ASCII, Acentos (Latin-1) ou Whitespace

            // 4. Se a op√ß√£o de remover emojis estiver marcada, remove a maioria dos s√≠mbolos complexos.
            if (removeEmojis) {
                // Remove a maioria dos emojis e s√≠mbolos complexos UTF-8
                text = text.replace(/(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g, '');
            }
            // 5. Limpa m√∫ltiplos espa√ßos em uma √∫nica linha
            text = text.replace(/[ \t]+/g, ' ').trim(); 
            return text;
        }

        // ====================================================================
        // GEST√ÉO DE TEMPLATE E UPLOAD
        // ====================================================================
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('templateText').value = e.target.result;
                    processTemplate();
                };
                reader.readAsText(file);
            } else if (file.type === 'application/pdf') {
                extractTextFromPDF(file);
            } else {
                alert('Formato de arquivo n√£o suportado. Use .txt ou .pdf.');
            }
        }

        async function extractTextFromPDF(file) {
            const removeEmojisFlag = document.getElementById('removeEmojisFlag') ? document.getElementById('removeEmojisFlag').checked : false;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                }

                const sanitizedText = sanitizeText(fullText.trim(), removeEmojisFlag);
                document.getElementById('templateText').value = sanitizedText;
                processTemplate(sanitizedText);
            } catch (error) {
                alert('Erro ao extrair texto do PDF. O arquivo pode estar protegido ou corrompido.');
                console.error(error);
            }
        }

        function processTemplate(content = null) {
            let textToProcess = content || document.getElementById('templateText').value;
            const removeEmojisFlag = document.getElementById('removeEmojisFlag') ? document.getElementById('removeEmojisFlag').checked : false;

            // Aplica a sanitiza√ß√£o ao texto atual do textarea
            textToProcess = sanitizeText(textToProcess, removeEmojisFlag);
            // Atualiza o textarea com o texto limpo
            document.getElementById('templateText').value = textToProcess;

            templateContent = textToProcess;

            const regex = /\{(\w+)\}/g;
            const matches = [...templateContent.matchAll(regex)];
            
            // Adicionar vari√°veis de blocos condicionais
            const conditionalRegex = /\{START_COND:(\w+)\}/g;
            const conditionalMatches = [...templateContent.matchAll(conditionalRegex)];

            const allMatches = matches.map(match => match[1]).concat(conditionalMatches.map(match => match[1]));
            
            const uniqueVarNames = [...new Set(allMatches)];

            const newVariables = uniqueVarNames.map(name => {
                const existing = variables.find(v => v.name === name);

                // Determina se √© uma vari√°vel condicional (START/END)
                const isConditionalBlock = templateContent.includes(`{START_COND:${name}}`);

                // Tenta inferir tipo e prop√≥sito para novas vari√°veis
                let inferredType = 'text';
                let inferredPlaceholder = '';
                let inferredPurpose = isConditionalBlock ? 'conditional' : 'form';
                let inferredCondition = isConditionalBlock ? '' : undefined;

                if (inferredPurpose === 'form') {
                    if (name.toLowerCase().includes('email')) { inferredType = 'email'; inferredPlaceholder = 'seu.email@exemplo.com'; } 
                    else if (name.toLowerCase().includes('data')) { inferredType = 'date'; } 
                    else if (name.toLowerCase().includes('cep')) { inferredType = 'text'; inferredPlaceholder = '99999-999'; } 
                    else if (name.toLowerCase().includes('cpf')) { inferredType = 'text'; inferredPlaceholder = '000.000.000-00'; } 
                    else if (name.toLowerCase().includes('cnpj')) { inferredType = 'text'; inferredPlaceholder = '00.000.000/0000-00'; } 
                    else if (name.toLowerCase().includes('tel') || name.toLowerCase().includes('fone')) { inferredType = 'tel'; inferredPlaceholder = '(99) 99999-9999'; } 
                    else if (name.toLowerCase().includes('valor') || name.toLowerCase().includes('preco') || name.toLowerCase().includes('salario') || name.toLowerCase().includes('total') || name.toLowerCase().includes('multa')) { inferredType = 'number'; inferredPlaceholder = '0.00'; } 
                    else if (name.toLowerCase().includes('numero') || name.toLowerCase().includes('quantidade')) { inferredType = 'number'; inferredPlaceholder = '0'; }
                }

                // Preserva configura√ß√µes se a vari√°vel j√° existe
                return existing || { 
                    name: name, 
                    label: name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 
                    type: inferredType, 
                    placeholder: inferredPlaceholder, 
                    required: inferredPurpose === 'form', 
                    purpose: inferredPurpose,
                    condition: inferredCondition
                };
            });

            variables = newVariables;
            // Remove vari√°veis antigas que n√£o est√£o mais no template
            variables = variables.filter(v => uniqueVarNames.includes(v.name)); 

            alert(`‚úÖ ${variables.length} vari√°veis detectadas! Prossiga para a aba 'Configurar Vari√°veis'.`);
            switchTab('config');
        }


        // ====================================================================
        // GEST√ÉO DE MODELOS SALVOS (Modais)
        // ====================================================================
        function saveTemplateModal() {
            if (variables.length === 0) {
                alert('Detecte as vari√°veis no template primeiro!');
                return;
            }
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            openModal('saveTemplateModal');
        }

        async function confirmSaveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const description = document.getElementById('templateDescription').value.trim();

            if (!name) {
                alert('O nome do template √© obrigat√≥rio.');
                return;
            }

            const template = {
                id: Date.now(), // ID √∫nico baseado no timestamp
                name: name,
                description: description,
                content: templateContent,
                variables: JSON.parse(JSON.stringify(variables)) // C√≥pia profunda
            };

            try {
                await saveTemplateToDB(template);
                savedTemplates.push(template);
                alert(`‚úÖ Template '${name}' salvo com sucesso!`);
                closeModal('saveTemplateModal');
            } catch (error) {
                alert('‚ùå Erro ao salvar o modelo. Verifique o console.');
                console.error(error);
            }
        }

        async function openLoadTemplateModal() {
            await loadSavedTemplatesAndRender();
            openModal('loadTemplateModal');
        }
        
        async function loadSavedTemplatesAndRender() {
            try {
                savedTemplates = await loadAllTemplatesFromDB();
                renderSavedTemplates();
            } catch (error) {
                document.getElementById('savedTemplatesList').innerHTML = '<p style="color: #dc3545;">Erro ao carregar modelos.</p>';
            }
        }

        function renderSavedTemplates() {
            const list = document.getElementById('savedTemplatesList');
            if (savedTemplates.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6c757d;">Nenhum modelo salvo ainda.</p>';
                return;
            }
            list.innerHTML = savedTemplates.map(t => `
                <div class="template-card" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 15px;">
                    <div>
                        <h5 style="margin: 0; color: #343a40;">${t.name}</h5>
                        <small style="color: #6c757d;">${t.description}</small>
                    </div>
                    <div>
                        <button class="btn-use" onclick="loadTemplate(${t.id})" style="margin-right: 10px;">Usar</button>
                        <button class="btn-delete-small" onclick="deleteTemplate(${t.id})">Deletar</button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteTemplate(id) {
            if (confirm('Tem certeza que deseja deletar este modelo?')) {
                try {
                    await deleteTemplateFromDB(id);
                    savedTemplates = savedTemplates.filter(t => t.id !== parseInt(id, 10));
                    renderSavedTemplates();
                    alert('‚úÖ Modelo deletado com sucesso!');
                } catch (error) {
                    alert('‚ùå Erro ao deletar o modelo.');
                    console.error(error);
                }
            }
        }

        function loadTemplate(id) {
            const numericId = parseInt(id, 10);
            const template = savedTemplates.find(t => t.id === numericId);
            if (!template) {
                alert('Template n√£o encontrado.');
                return;
            }

            // O conte√∫do salvo no banco de dados j√° deve estar sanitizado,
            // mas o processamento de vari√°veis ser√° feito com a fun√ß√£o padr√£o.
            templateContent = template.content;
            variables = JSON.parse(JSON.stringify(template.variables));
            formData = {}; // Limpa dados anteriores
            document.getElementById('templateText').value = templateContent;
            alert(`‚úÖ Template '${template.name}' carregado. Prossiga para a aba 'Preencher Formul√°rio'.`);
            closeModal('loadTemplateModal');
            switchTab('fill');
        }

        function loadPredefinedTemplate(id) {
            const template = predefinedTemplates.find(t => t.id === id);
            if (!template) return;

            templateContent = template.content;
            variables = JSON.parse(JSON.stringify(template.variables));
            formData = {}; // Limpa dados anteriores
            document.getElementById('templateText').value = templateContent;
            alert(`‚úÖ Template '${template.name}' carregado. Prossiga para a aba 'Preencher Formul√°rio'.`);
            switchTab('fill');
        }


        // ====================================================================
        // CONFIGURA√á√ÉO DE VARI√ÅVEIS
        // ====================================================================
        function updateVariable(index, key, value) {
            if (key === 'required' || key === 'isPercentage') {
                variables[index][key] = value;
            } else if (key === 'type' && value === 'select') {
                variables[index][key] = value;
                // Inicializa op√ß√µes vazias se mudar para select
                if (!variables[index].options) variables[index].options = ''; 
            } else if (key === 'type' && value !== 'select') {
                variables[index][key] = value;
                // Remove op√ß√µes se mudar de select
                delete variables[index].options; 
            } else {
                variables[index][key] = value;
            }
            // Re-renderiza para refletir as mudan√ßas (ex: op√ß√µes de select)
            renderConfigTab(); 
        }

        function updatePurpose(index, purpose) {
            variables[index].purpose = purpose;
            if (purpose === 'calculation') {
                variables[index].required = false;
                variables[index].type = 'number';
            } else if (purpose === 'conditional') {
                 variables[index].required = false;
                 variables[index].type = 'text';
            } else { // Form (padr√£o)
                 variables[index].required = true;
            }
            // Re-renderiza ap√≥s a mudan√ßa de prop√≥sito para mostrar a config correta
            renderConfigTab();
        }

        function renderConfigTab() {
            const container = document.getElementById('variablesConfig');
            container.innerHTML = '';

            if (variables.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">Nenhuma vari√°vel detectada ainda. Fa√ßa upload de um template primeiro.</p>';
                return;
            }

            // Renderiza√ß√£o de Vari√°veis Normais
            variables.forEach((variable, index) => {
                const card = document.createElement('div');
                card.className = 'variable-card';
                if (variable.purpose === 'conditional') {
                    card.classList.add('conditional');
                } else if (variable.purpose === 'calculation') {
                    card.classList.add('calculation');
                }

                let purposeConfigHtml = '';
                if (variable.purpose === 'calculation') {
                    purposeConfigHtml = `
                        <div class="calculation-field-config form-group">
                            <label>F√≥rmula de C√°lculo:</label>
                            <input type="text" value="${variable.calculationFormula || ''}" onchange="updateVariable(${index}, 'calculationFormula', this.value)" placeholder="Ex: {valor_base} * (1 + {percentual})">
                            <small>Use {chaves}, operadores (+, -, *, /) e **%** para porcentagens literais.</small>
                        </div>
                    `;
                } else if (variable.purpose === 'conditional') {
                    purposeConfigHtml = `
                        <div class="conditional-field-config form-group">
                            <label>Exibir Apenas Se (Condi√ß√£o):</label>
                            <input type="text" value="${variable.condition || ''}" onchange="updateVariable(${index}, 'condition', this.value)" placeholder="Ex: {tipo_pessoa} == 'juridica' ">
                            <small>Use {chaves}, ==, !=, >, <. Vari√°veis devem ser definidas antes de serem usadas na condi√ß√£o.</small>
                        </div>
                    `;
                }

                let selectOptionsHtml = '';
                if (variable.type === 'select') {
                    selectOptionsHtml = `
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Op√ß√µes de Sele√ß√£o (Separadas por V√≠rgula):</label>
                            <input type="text" value="${variable.options || ''}" onchange="updateVariable(${index}, 'options', this.value)" placeholder="Ex: Sim, N√£o, Talvez">
                            <small>Valores que aparecer√£o no menu suspenso.</small>
                        </div>
                    `;
                }
                
                let isPercentageHtml = '';
                if (variable.type === 'number' && variable.purpose === 'form') {
                    isPercentageHtml = `
                        <div class="checkbox-group" style="margin-top: 15px;">
                            <input type="checkbox" id="isPercentage-${index}" ${variable.isPercentage ? 'checked' : ''} onchange="updateVariable(${index}, 'isPercentage', this.checked)">
                            <label for="isPercentage-${index}" style="display: inline; font-weight: normal;">Considerar este valor como **percentual** (dividir por 100 no c√°lculo)?</label>
                        </div>
                    `;
                }


                card.innerHTML = `
                    <h4 style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span>{${variable.name}}</span>
                        <select onchange="updatePurpose(${index}, this.value)" style="padding: 5px; border-radius: 5px; font-size: 14px; width: auto;">
                            <option value="form" ${variable.purpose === 'form' ? 'selected' : ''}>Campo de Formul√°rio (Normal)</option>
                            <option value="calculation" ${variable.purpose === 'calculation' ? 'selected' : ''}>C√°lculo Autom√°tico (Verde)</option>
                            <option value="conditional" ${variable.purpose === 'conditional' ? 'selected' : ''}>Bloco Condicional (Amarelo)</option>
                        </select>
                    </h4>
                    <hr style="margin: 10px 0;">
                    
                    ${purposeConfigHtml}

                    <div class="form-group">
                        <label>R√≥tulo/Label:</label>
                        <input type="text" value="${variable.label}" onchange="updateVariable(${index}, 'label', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Campo:</label>
                        <select onchange="updateVariable(${index}, 'type', this.value)" ${variable.purpose === 'calculation' || variable.purpose === 'conditional' ? 'disabled' : ''}>
                            <option value="text" ${variable.type === 'text' ? 'selected' : ''}>Texto Curto</option>
                            <option value="select" ${variable.type === 'select' ? 'selected' : ''}>Sele√ß√£o (Dropdown)</option>
                            <option value="email" ${variable.type === 'email' ? 'selected' : ''}>Email</option>
                            <option value="number" ${variable.type === 'number' ? 'selected' : ''}>N√∫mero/Moeda</option>
                            <option value="date" ${variable.type === 'date' ? 'selected' : ''}>Data</option>
                            <option value="tel" ${variable.type === 'tel' ? 'selected' : ''}>Telefone</option>
                            <option value="url" ${variable.type === 'url' ? 'selected' : ''}>URL</option>
                            <option value="textarea" ${variable.type === 'textarea' ? 'selected' : ''}>Texto Longo</option>
                        </select>
                    </div>
                    
                    ${selectOptionsHtml}
                    ${isPercentageHtml}
                    
                    <div class="form-group">
                        <label>Placeholder/Dica:</label>
                        <input type="text" value="${variable.placeholder}" onchange="updateVariable(${index}, 'placeholder', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>Descri√ß√£o/Ajuda:</label>
                        <input type="text" value="${variable.description}" onchange="updateVariable(${index}, 'description', this.value)">
                    </div>
                    
                    <div class="checkbox-group" ${variable.purpose !== 'form' ? 'style="display: none;"' : ''}>
                        <input type="checkbox" id="required-${index}" ${variable.required ? 'checked' : ''} onchange="updateVariable(${index}, 'required', this.checked)">
                        <label for="required-${index}">Campo obrigat√≥rio</label>
                    </div>
                `;
                container.appendChild(card);
            });
            updateStats();
        }

        /**
         * Renderiza a aba de preenchimento.
         */
        function renderFormTab() {
            const container = document.getElementById('formFields');
            container.innerHTML = '';

            if (variables.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">Configure as vari√°veis primeiro.</p>';
                return;
            }

            // Renderizar Vari√°veis Normais
            variables.forEach((variable) => {
                // N√£o renderiza campos de c√°lculo ou condicional (eles s√£o manipulados internamente)
                if (variable.purpose !== 'form') return; 

                const group = document.createElement('div');
                group.className = 'form-group';
                group.setAttribute('data-var-name', variable.name);

                const label = document.createElement('label');
                label.textContent = variable.label + (variable.required ? ' *' : '');
                group.appendChild(label);

                let input;

                // Tipo Select
                if (variable.type === 'select' && variable.options) {
                    input = document.createElement('select');
                    const placeholderOption = document.createElement('option');
                    placeholderOption.value = '';
                    placeholderOption.textContent = variable.placeholder || 'Selecione uma op√ß√£o';
                    placeholderOption.disabled = true;
                    placeholderOption.selected = !formData[variable.name];
                    input.appendChild(placeholderOption);

                    variable.options.split(',').map(s => s.trim()).forEach(optionText => {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        if (formData[variable.name] === optionText) {
                            option.selected = true;
                        }
                        input.appendChild(option);
                    });
                } 
                // Tipo TextArea
                else if (variable.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.placeholder = variable.placeholder || '';
                    input.value = formData[variable.name] || '';
                    input.style.minHeight = '100px'; 
                } 
                // Tipos de Input Padr√£o
                else {
                    input = document.createElement('input');
                    input.type = variable.type;
                    input.placeholder = variable.placeholder || '';
                    input.value = formData[variable.name] || '';
                }

                input.id = `input-${variable.name}`;
                input.name = variable.name;
                input.required = variable.required;

                input.oninput = (e) => {
                    let val = e.target.value;
                    
                    // Tratamento especial para n√∫meros formatados com VMasker
                    if (variable.type === 'number' && window.VMasker) {
                         // Remove R$ e separadores de milhar para obter o n√∫mero real
                        val = val.replace(/[R$\.]/g, '').replace(',', '.');
                    }
                    
                    formData[variable.name] = val;
                    updateAllCalculations();
                    updateAllConditionals();
                    updateProgress();

                    // Autocompletar CEP
                    if (variable.name.toLowerCase().includes('cep')) {
                        handleCepChange(input, variable.name);
                    }
                };
                
                // Aplica√ß√£o de M√°scaras (Vanilla Masker)
                if (window.VMasker && variable.type !== 'select' && input.type === 'text') {
                    const varName = variable.name.toLowerCase();
                    if (varName.includes('cpf')) {
                        VMasker(input).maskPattern('999.999.999-99');
                    } else if (varName.includes('cnpj')) {
                        VMasker(input).maskPattern('99.999.999/9999-99');
                    } else if (varName.includes('cep')) {
                        VMasker(input).maskPattern('99999-999');
                    } else if (variable.type === 'tel') {
                        VMasker(input).maskPattern(['(99) 9999-9999', '(99) 99999-9999']);
                    } else if (variable.type === 'number' && (varName.includes('valor') || varName.includes('preco') || varName.includes('salario') || varName.includes('total') || varName.includes('multa'))) {
                        VMasker(input).maskMoney({ precision: 2, separator: ',', delimiter: '.', unit: 'R$' });
                    }
                }

                group.appendChild(input);

                if (variable.description) {
                    const small = document.createElement('small');
                    small.textContent = variable.description;
                    group.appendChild(small);
                }

                container.appendChild(group);
            });

            updateAllCalculations();
            updateAllConditionals();
            updateProgress();
        }

        // ====================================================================
        // L√ìGICA DE C√ÅLCULO E CONDICIONAL
        // ====================================================================
        function updateAllCalculations() {
            const calculationVariables = variables.filter(v => v.purpose === 'calculation');
            let recalculated = false;

            do {
                recalculated = false;
                calculationVariables.forEach(variable => {
                    const oldValue = formData[variable.name];
                    const newValue = calculateFieldValue(variable.calculationFormula);
                    
                    if (oldValue !== newValue) {
                        formData[variable.name] = newValue;
                        
                        // Atualiza o campo no formul√°rio se estiver vis√≠vel (apesar de ser s√≥ c√°lculo)
                        const inputField = document.querySelector(`#formFields [data-var-name="${variable.name}"] input, #formFields [data-var-name="${variable.name}"] select, #formFields [data-var-name="${variable.name}"] textarea`);
                        if (inputField) {
                            inputField.value = newValue; // Apenas para exibi√ß√£o em debug, se houver
                        }
                        recalculated = true; // For√ßa nova itera√ß√£o se um valor mudou
                    }
                });
            } while (recalculated); // Continua recalculando se alguma vari√°vel mudou na √∫ltima itera√ß√£o
            
            // Re-renderiza a aba de preenchimento para atualizar valores dos campos
            updateProgress(); 
        }

        function calculateFieldValue(formula) {
            if (!formula) return 0;
            let expression = formula;

            // 1. Substitui vari√°veis {var} por seus valores reais, tratando valores vazios como 0
            variables.filter(v => v.purpose !== 'calculation').forEach(v => {
                let value = formData[v.name];
                
                // Limpa valores de m√°scara (R$, .)
                if (typeof value === 'string') {
                    value = value.replace(/[R$\.]/g, '').replace(',', '.');
                }
                
                let numericValue = parseFloat(value) || 0;
                
                // Se for um campo percentual, divide por 100 ANTES do c√°lculo
                if (v.isPercentage && v.type === 'number') {
                    numericValue = numericValue / 100;
                }

                // Substitui a vari√°vel na f√≥rmula
                const regex = new RegExp(`\\{${v.name}\\}`, 'g');
                expression = expression.replace(regex, numericValue);
            });
            
            try {
                // 2. Trata porcentagens literais na f√≥rmula (ex: 10% -> 0.1)
                // Isto √© mais para uso avan√ßado na f√≥rmula, preferimos o 'isPercentage' no campo de formul√°rio
                expression = expression.replace(/(\d+(\.\d+)?)%/g, '($1/100)'); 

                // 3. Avalia a express√£o.
                const result = new Function(`return ${expression}`)();

                if (typeof result === 'number' && isFinite(result)) {
                    return parseFloat(result.toFixed(2));
                }
                return result;
            } catch (e) {
                console.error("Erro ao calcular f√≥rmula:", formula, e);
                return 'ERRO: ' + e.message;
            }
        }

        function updateAllConditionals() {
            variables.filter(v => v.purpose === 'conditional').forEach(variable => {
                const isVisible = checkCondition(variable);
                // N√£o h√° elementos no formul√°rio para 'conditional', mas manipulamos o valor no formData.
                // Na verdade, o bloco condicional √© tratado no getFinalDocumentText.
                // Aqui apenas garantimos que se a condi√ß√£o for falsa, o valor no formData √© nulo, 
                // for√ßando a remo√ß√£o do bloco no documento final.
                
                // O valor real da vari√°vel condicional √© 1 (verdadeiro) ou 0 (falso) para o document final.
                formData[variable.name] = isVisible ? '1' : '';

            });
            updateProgress();
        }

        function checkCondition(variable) {
            if (variable.purpose !== 'conditional' || !variable.condition) return false; // Se n√£o tem condi√ß√£o, o bloco √© considerado 'false'

            let condition = variable.condition;
            const matches = [...condition.matchAll(/\{(\w+)\}/g)];

            try {
                matches.forEach(match => {
                    const varName = match[1];
                    let value = formData[varName] || ''; 
                    
                    // Trata valores num√©ricos para a avalia√ß√£o (ex: {valor} > 100)
                    if (variables.find(v => v.name === varName && v.type === 'number')) {
                        // Limpa R$ e v√≠rgulas para que a compara√ß√£o num√©rica funcione
                        value = (value.toString().replace(/[R$\.]/g, '').replace(',', '.') || 0);
                        condition = condition.replace(new RegExp(`\\{${varName}\\}`, 'g'), value);
                    } 
                    // Trata valores de string
                    else if (typeof value === 'string') {
                        condition = condition.replace(new RegExp(`\\{${varName}\\}`, 'g'), `'${value}'`);
                    } else {
                        condition = condition.replace(new RegExp(`\\{${varName}\\}`, 'g'), value);
                    }
                });
                
                return new Function(`return ${condition}`)();
            } catch (e) {
                console.warn(`Condi√ß√£o inv√°lida para {${variable.name}}: "${variable.condition}". Erro: ${e.message}`);
                return false;
            }
        }

        // ====================================================================
        // VALIDA√á√ïES E ENDERE√áO
        // ====================================================================
        function validateCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let sum = 0, remainder;
            for (let i = 1; i <= 9; i++) sum += parseInt(cpf.substring(i - 1, i)) * (11 - i);
            remainder = (sum * 10) % 11;
            if ((remainder == 10) || (remainder == 11)) remainder = 0;
            if (remainder != parseInt(cpf.substring(9, 10))) return false;
            sum = 0;
            for (let i = 1; i <= 10; i++) sum += parseInt(cpf.substring(i - 1, i)) * (12 - i);
            remainder = (sum * 10) % 11;
            if ((remainder == 10) || (remainder == 11)) remainder = 0;
            if (remainder != parseInt(cpf.substring(10, 11))) return false;
            return true;
        }

        function validateCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]+/g, '');
            if (cnpj.length !== 14 || /^(\d)\1{13}$/.test(cnpj)) return false;
            let size = cnpj.length - 2;
            let numbers = cnpj.substring(0, size);
            let digits = cnpj.substring(size);
            let sum = 0;
            let pos = size - 7;
            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }
            let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(0)) return false;
            size = size + 1;
            numbers = cnpj.substring(0, size);
            sum = 0;
            pos = size - 7;
            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }
            result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(1)) return false;
            return true;
        }

        function handleCepChange(input, varName) {
            const cep = input.value.replace(/\D/g, '');
            if (cep.length !== 8) return;

            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        // Determina o prefixo base da vari√°vel (√∫til se tivermos {cep_empresa}, {endereco_completo_empresa})
                        const baseName = varName.replace(/(_)?cep/i, ''); 

                        const addressMapping = {
                            'logradouro': data.logradouro,
                            'bairro': data.bairro,
                            'cidade': data.localidade,
                            'uf': data.uf,
                            'estado': data.uf
                        };

                        // 1. Encontra a vari√°vel de Endere√ßo Completo e atualiza
                        const enderecoCompletoVar = variables.find(v => v.name.includes('endereco_completo'));
                        if (enderecoCompletoVar) {
                            formData[enderecoCompletoVar.name] = `${data.logradouro}, ${data.bairro}, ${data.localidade}/${data.uf}`;
                            // Atualiza o campo no DOM
                            const inputEndCompleto = document.getElementById(`input-${enderecoCompletoVar.name}`);
                            if (inputEndCompleto) {
                                inputEndCompleto.value = formData[enderecoCompletoVar.name];
                            }
                        }

                        // 2. Tenta preencher vari√°veis individuais (ex: {cidade}, {bairro}, {uf})
                        variables.forEach(v => {
                            const vNameLower = v.name.toLowerCase();
                            const key = Object.keys(addressMapping).find(k => vNameLower.includes(baseName + '_' + k) || vNameLower.includes(k));

                            if (key && addressMapping[key] && !v.name.includes('endereco_completo')) {
                                // Garante que n√£o sobrescreve o campo do usu√°rio se j√° estiver preenchido de forma diferente
                                if (!formData[v.name] || formData[v.name] === '') {
                                    formData[v.name] = addressMapping[key];
                                    // Atualiza o campo no DOM
                                    const inputField = document.getElementById(`input-${v.name}`);
                                    if (inputField) {
                                        inputField.value = addressMapping[key];
                                    }
                                }
                            }
                        });
                        
                        updateProgress();
                        
                    } else {
                        showNotification('CEP n√£o encontrado.', 3000);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar CEP:', error);
                    showNotification('Erro na comunica√ß√£o com o servi√ßo de CEP.', 3000);
                });
        }

        // ====================================================================
        // PROGRESSO E ESTAT√çSTICAS
        // ====================================================================
        function getRequiredVariables() {
            return variables.filter(v => v.required && v.purpose === 'form');
        }

        function updateProgress() {
            const requiredVars = getRequiredVariables();
            const filledCount = requiredVars.filter(v => {
                const value = formData[v.name];
                return value !== null && value !== undefined && value.toString().trim() !== '';
            }).length;
            const totalCount = requiredVars.length;

            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');

            const percentage = totalCount > 0 ? (filledCount / totalCount) * 100 : 100;

            progressBarFill.style.width = `${percentage}%`;
            progressText.textContent = `${filledCount} de ${totalCount} campos obrigat√≥rios preenchidos`;

            // Garante que a barra n√£o fique vazia se 100%
            if (percentage === 100 && totalCount > 0) {
                 progressBarFill.textContent = '100% Completo';
            } else if (percentage > 20) {
                 progressBarFill.textContent = `${Math.round(percentage)}%`;
            } else {
                 progressBarFill.textContent = '';
            }
        }
        
        function updateStats() {
            // No momento, apenas a aba de Configura√ß√£o
        }

        // ====================================================================
        // PREVIEW E DOWNLOAD
        // ====================================================================
        function generatePreview() {
            const validationMessages = [];
            const requiredVars = getRequiredVariables();
            const visibleVariables = variables.filter(v => v.purpose === 'form' || v.purpose === 'calculation');

            // 1. Valida√ß√£o de Campos Obrigat√≥rios
            const emptyRequired = requiredVars.filter(v => {
                const value = formData[v.name];
                return value === null || value === undefined || value.toString().trim() === '';
            });

            if (emptyRequired.length > 0) {
                validationMessages.push(`‚ùå **Campos obrigat√≥rios vazios:** ${emptyRequired.map(v => v.label).join(', ')}`);
            }

            // 2. Valida√ß√£o de CPF e CNPJ (FEEDBACK CLARO)
            visibleVariables.forEach(v => {
                const value = formData[v.name];
                if (!value || !value.toString().trim()) return;

                const nameLower = v.name.toLowerCase();

                if (nameLower.includes('cpf')) {
                    if (!validateCPF(value)) {
                        validationMessages.push(`‚ùå **CPF inv√°lido** no campo: ${v.label}. Por favor, verifique se est√° completo (11 d√≠gitos) e √© v√°lido.`);
                    }
                } else if (nameLower.includes('cnpj')) {
                    if (!validateCNPJ(value)) {
                        validationMessages.push(`‚ùå **CNPJ inv√°lido** no campo: ${v.label}. Por favor, verifique se est√° completo (14 d√≠gitos) e √© v√°lido.`);
                    }
                }
            });

            const errorContainer = document.getElementById('validationErrors');
            if (validationMessages.length > 0) {
                errorContainer.style.display = 'flex';
                errorContainer.className = 'alert-error';

                // Mensagem geral de instru√ß√£o clara
                const generalInstruction = `<div>‚ö†Ô∏è **Erros de Valida√ß√£o Encontrados:** Corrija os campos com erros na aba 'Preencher Formul√°rio' antes de gerar o documento.</div>`;
                errorContainer.innerHTML = generalInstruction + validationMessages.map(msg => `<div>${msg}</div>`).join('');
                switchTab('fill'); // Volta para a aba de preenchimento (onde o container est√° agora)
                return;
            } else {
                errorContainer.style.display = 'none';
            }

            generateLivePreview();
            switchTab('preview');
        }

        function generateLivePreview() {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = getFinalDocumentText(true);
        }
        
        /**
         * Gera o texto final do documento, com ou sem destaque para preview.
         * @param {boolean} isPreviewMode - Se deve adicionar destaques para campos vazios e preenchidos.
         */
        function getFinalDocumentText(isPreviewMode) {
            let finalDoc = templateContent;

            // 1. Substituir vari√°veis normais e de c√°lculo
            variables.filter(v => v.purpose !== 'conditional').forEach(v => {
                let value = formData[v.name];
                
                // Formata√ß√£o para exibi√ß√£o
                if (v.type === 'number' && typeof value === 'string') {
                    // Tenta remover formata√ß√£o R$ e formatar de volta
                    const numericValue = value.replace(/[R$\.]/g, '').replace(',', '.');
                    value = parseFloat(numericValue);
                } else if (v.type === 'number' && typeof value === 'number') {
                    // Formata n√∫meros para moeda brasileira
                    value = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                }
                
                // Se o valor estiver vazio, formata para visualiza√ß√£o no preview
                if (value === null || value === undefined || value.toString().trim() === '' || (typeof value === 'number' && isNaN(value))) {
                    value = isPreviewMode ? `<span class="highlight" style="background: #ffcccc;">{${v.name} Vazio}</span>` : '';
                } else {
                    // Destaque para campos preenchidos no preview
                    if (isPreviewMode) {
                        value = `<span class="highlight">${value}</span>`;
                    }
                }

                // Substitui√ß√£o no documento
                const regex = new RegExp(`\\{${v.name}\\}`, 'g');
                finalDoc = finalDoc.replace(regex, value);
            });

            // 2. Processar blocos condicionais
            // Regex para encontrar blocos: {START_COND:variavel} ... {END_COND:variavel}
            const conditionalBlockRegex = /\{START_COND:(\w+)\}([\s\S]*?)\{END_COND:(\w+)\}/g;
            
            finalDoc = finalDoc.replace(conditionalBlockRegex, (match, startVar, content, endVar) => {
                // Se as tags de in√≠cio e fim n√£o coincidirem, mantenha o bloco (ou trate como erro)
                if (startVar !== endVar) {
                    console.error(`Erro de tag no bloco condicional: START {${startVar}} e END {${endVar}}`);
                    return match; // Retorna o texto original para n√£o perder o conte√∫do
                }
                
                // Verifica o valor da vari√°vel condicional no formData (0 = false, 1 = true)
                const isConditionMet = formData[startVar] === '1';

                if (isConditionMet) {
                    return content; // Mant√©m o conte√∫do do bloco
                } else {
                    // Remove o bloco (texto vazio)
                    return ''; 
                }
            });

            // 3. Remove tags vazias que n√£o foram substitu√≠das (apenas para o download final)
            if (!isPreviewMode) {
                 finalDoc = finalDoc.replace(/\{(\w+)\}/g, '');
            }


            // 4. Limpeza final de m√∫ltiplos espa√ßos, quebras de linha e texto html
            if (!isPreviewMode) {
                 // Remove m√∫ltiplos espa√ßos/tabs e m√∫ltiplas quebras de linha (deixa no m√°ximo 2)
                 finalDoc = finalDoc.replace(/[ \t]+/g, ' ').replace(/\n\s*\n/g, '\n\n').trim();
            }

            return finalDoc;
        }

        function downloadDocument() {
            const finalDoc = getFinalDocumentText(false);
            const blob = new Blob([finalDoc], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'documento_preenchido.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadDocumentPDF() {
            const finalDoc = getFinalDocumentText(false);
            const { jsPDF } = window.jspdf;
            
            const doc = new jsPDF({
                unit: 'mm',
                format: 'a4'
            });
            
            doc.setFont('Helvetica'); 
            doc.setFontSize(10);
            
            const splitText = doc.splitTextToSize(finalDoc, 190); 
            
            let y = 10;
            const lineHeight = 5; 

            splitText.forEach(line => {
                if (y > 280) { 
                    doc.addPage();
                    y = 10; 
                }
                doc.text(line, 10, y);
                y += lineHeight;
            });
            
            doc.save("documento_preenchido.pdf");
            
            showNotification('‚úÖ PDF gerado. Verifique seus downloads!', 5000);
        }

        function copyToClipboard() {
            const text = getFinalDocumentText(false);
            navigator.clipboard.writeText(text).then(() => {
                showNotification('‚úÖ Texto copiado para a √°rea de transfer√™ncia!', 3000);
            });
        }

        function clearForm() {
            if (confirm('Tem certeza que deseja limpar todos os campos? Isso √© irrevers√≠vel.')) {
                formData = {};
                renderFormTab();
                document.getElementById('validationErrors').style.display = 'none'; // Esconde erros anteriores
                showNotification('Formul√°rio limpo com sucesso.', 3000);
            }
        }
    </script>
</body>
</html>